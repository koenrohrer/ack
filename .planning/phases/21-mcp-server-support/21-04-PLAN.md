---
phase: 21-mcp-server-support
plan: "04"
type: execute
wave: 3
depends_on: ["21-02", "21-03"]
files_modified: []
autonomous: false
requirements: [MCP-01, MCP-02, MCP-03, MCP-04, MCP-05]

must_haves:
  truths:
    - "User can see Copilot MCP servers listed in the sidebar under the Copilot environment (workspace scope)"
    - "User can see user-scoped Copilot MCP servers from VS Code profile mcp.json in the sidebar"
    - "User can install a Copilot MCP server from the marketplace and see it appear in the sidebar"
    - "User can remove a Copilot MCP server from the sidebar and confirm it is deleted from .vscode/mcp.json"
    - "Editing .vscode/mcp.json externally causes the sidebar to refresh without restarting VS Code"
  artifacts: []
  key_links: []
---

<objective>
Human verification checkpoint to confirm all five MCP requirements (MCP-01 through MCP-05) work end-to-end in the running extension. Plans 21-01 through 21-03 implement and test the logic; this plan validates the integrated behavior in a live VS Code instance.

Purpose: Automated tests cover unit-level correctness, but this checkpoint confirms the sidebar tree, marketplace install, and file watcher all work together as a user would experience them.

Output: Verified pass or issue report. If issues are found, describe them so gap closure can be planned.
</objective>

<execution_context>
@/Users/koenrohrer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/koenrohrer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build extension and run final test suite</name>
  <files></files>
  <action>
Run the full build and test suite to confirm Phase 21 is in a clean, shippable state before human verification:

1. `cd /Users/koenrohrer/Agent-Config-Keeper && npm run compile` — full TypeScript compile, zero errors
2. `cd /Users/koenrohrer/Agent-Config-Keeper && npm test` — all tests pass including the new `copilot-mcp.test.ts` suite
3. Report the test count from copilot-mcp suite and overall pass/fail summary

If either step fails, stop and report the failure rather than proceeding to the human checkpoint.
  </action>
  <verify>
`npm run compile` exits with code 0. `npm test` exits with code 0. Output confirms copilot-mcp tests ran and passed.
  </verify>
  <done>
Build and full test suite pass with zero errors and zero failing tests.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Phase 21 MCP requirements</name>
  <action>Verify all five MCP requirements (MCP-01 through MCP-05) work end-to-end in the running Extension Development Host by following the steps in how-to-verify.</action>
  <what-built>
Phase 21 MCP Server Support — complete implementation:
- Copilot MCP schema (`schemas.ts`) with `servers` key and `inputs` array preservation
- `parseCopilotMcpFile()` reading workspace `.vscode/mcp.json` and user-scope `{Code/User}/mcp.json`
- `addCopilotMcpServer()` and `removeCopilotMcpServer()` via safe write pipeline
- CopilotAdapter methods `readTools`, `removeTool`, `installMcpServer`, `getWatchPaths` fully implemented
- Schema registered in `extension.ts`
- `getJsonPath()` in `tool-tree.command-utils.ts` now returns `['servers', name]` for Copilot (was incorrectly `['mcpServers', name]`)
  </what-built>
  <how-to-verify>
Run the extension in Extension Development Host (`F5` in VS Code or `npm run watch` + open extension host):

**MCP-01 — Workspace MCP servers in sidebar:**
1. Create a test file at `{your-workspace}/.vscode/mcp.json`:
   ```json
   {
     "servers": {
       "my-test-server": {
         "type": "stdio",
         "command": "node",
         "args": ["server.js"]
       }
     }
   }
   ```
2. Switch active agent to "GitHub Copilot" in the status bar
3. Open the ACK sidebar panel
4. Confirm "my-test-server" appears in the MCP Servers section with status Enabled

**MCP-02 — User-scope MCP servers in sidebar:**
1. Locate your VS Code user `mcp.json` (typically `~/Library/Application Support/Code/User/mcp.json` on macOS)
2. Add a server entry under `"servers"` key (or the file may already exist)
3. Confirm user-scope servers appear in the sidebar (distinct from workspace-scope)

**MCP-03 — Install from marketplace:**
1. Open the ACK marketplace panel with Copilot as active agent
2. Find a Copilot-compatible MCP server tool
3. Click "Install" → select workspace scope
4. Confirm the server appears in the sidebar and `.vscode/mcp.json` now contains a `servers` entry

**MCP-04 — Remove from sidebar:**
1. Hover over a Copilot MCP server in the sidebar — confirm trash icon appears
2. Click trash icon (or right-click → Remove)
3. Confirm the server disappears from sidebar and `.vscode/mcp.json` no longer contains the entry
4. Confirm any `"inputs"` array in the file is still present after removal (no data loss)

**MCP-05 — Auto-refresh on external edit:**
1. With `.vscode/mcp.json` open in a text editor
2. Manually add a new entry under `"servers"` and save
3. Confirm the sidebar refreshes and shows the new entry without restarting VS Code or the extension

**Bonus check — "Open Tool Source" command:**
1. Right-click a Copilot MCP server in the sidebar → "Open Tool Source"
2. Confirm `.vscode/mcp.json` opens and the cursor lands near the correct server entry (not at the top of the file due to wrong key path)
  </how-to-verify>
  <resume-signal>
Type "approved" if all five MCP requirements pass. Or describe any issues observed (which step failed, what happened, expected vs actual) so gap closure can be planned.
  </resume-signal>
</task>

</tasks>

<verification>
Human has approved the checkpoint or issues have been documented for gap closure.
</verification>

<success_criteria>
All five MCP requirements pass in the running extension:
- MCP-01: Workspace MCP servers visible in Copilot sidebar
- MCP-02: User-scope MCP servers visible in Copilot sidebar
- MCP-03: Marketplace install writes to .vscode/mcp.json under `servers` key
- MCP-04: Sidebar remove deletes the entry, `inputs` array intact
- MCP-05: External edit to .vscode/mcp.json triggers sidebar auto-refresh
</success_criteria>

<output>
After completion, create `.planning/phases/21-mcp-server-support/21-04-SUMMARY.md`
</output>
