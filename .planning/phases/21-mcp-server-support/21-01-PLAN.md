---
phase: 21-mcp-server-support
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/adapters/copilot/schemas.ts
  - src/adapters/copilot/parsers/mcp.parser.ts
  - src/adapters/copilot/writers/mcp.writer.ts
autonomous: true
requirements: [MCP-01, MCP-02, MCP-03, MCP-04]

must_haves:
  truths:
    - "parseCopilotMcpFile() reads the `servers` key and returns NormalizedTool[] with ToolStatus.Enabled for every entry"
    - "parseCopilotMcpFile() returns [] (not an error) when the file does not exist"
    - "parseCopilotMcpFile() returns a single ToolStatus.Error tool when the JSON is malformed or schema-invalid"
    - "addCopilotMcpServer() spreads the existing file object so the `inputs` array is never lost on write-back"
    - "removeCopilotMcpServer() deletes the named entry from `servers` and writes back the rest of the file unchanged"
    - "The copilot-mcp schema validates a file with both `servers` and `inputs` top-level keys without stripping either"
  artifacts:
    - path: "src/adapters/copilot/schemas.ts"
      provides: "CopilotMcpFileSchema + copilotSchemas registry map"
      exports: ["CopilotMcpFileSchema", "copilotSchemas"]
    - path: "src/adapters/copilot/parsers/mcp.parser.ts"
      provides: "parseCopilotMcpFile() — reads servers key from mcp.json"
      exports: ["parseCopilotMcpFile"]
    - path: "src/adapters/copilot/writers/mcp.writer.ts"
      provides: "addCopilotMcpServer() and removeCopilotMcpServer() — write via ConfigService pipeline"
      exports: ["addCopilotMcpServer", "removeCopilotMcpServer"]
  key_links:
    - from: "src/adapters/copilot/parsers/mcp.parser.ts"
      to: "src/adapters/copilot/schemas.ts"
      via: "schemaService.validate('copilot-mcp', data)"
      pattern: "schemaService\\.validate\\('copilot-mcp'"
    - from: "src/adapters/copilot/writers/mcp.writer.ts"
      to: "src/services/config.service.ts"
      via: "configService.writeConfigFile(filePath, 'copilot-mcp', mutator)"
      pattern: "configService\\.writeConfigFile.*copilot-mcp"
---

<objective>
Create the three pure-logic files that implement Copilot MCP server read/write capabilities: schema definitions, an mcp.json parser, and a writer. These files have no VS Code dependency and follow exact patterns established by `src/adapters/claude-code/parsers/mcp.parser.ts` and `src/adapters/claude-code/writers/mcp.writer.ts`, with the critical difference that Copilot uses the `servers` key (not `mcpServers`).

Purpose: Provide the building blocks that Plan 02 wires into CopilotAdapter — parser and writer are useless until the adapter calls them, but creating them first allows Plan 02 and Plan 03 (TDD) to proceed in parallel.

Output: Three new files under `src/adapters/copilot/`
</objective>

<execution_context>
@/Users/koenrohrer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/koenrohrer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-mcp-server-support/21-RESEARCH.md
@src/adapters/claude-code/schemas.ts
@src/adapters/claude-code/parsers/mcp.parser.ts
@src/adapters/claude-code/writers/mcp.writer.ts
@src/adapters/copilot/paths.ts
@src/types/config.ts
@src/types/enums.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Copilot MCP schemas</name>
  <files>src/adapters/copilot/schemas.ts</files>
  <action>
Create `src/adapters/copilot/schemas.ts` following the same structure as `src/adapters/claude-code/schemas.ts`.

Define these exports:

1. `CopilotMcpServerSchema` — Zod object with fields `type` (enum stdio/http/sse, optional), `command` (string, optional), `args` (string[], optional), `env` (record, optional), `envFile` (string, optional), `url` (string, optional), `headers` (record, optional). Use `.passthrough()` so unknown vendor fields survive round-trips. Note: Copilot servers have no `disabled` field — do not include it.

2. `CopilotMcpInputSchema` — Zod object with fields `type` (string), `id` (string), `description` (string, optional), `password` (boolean, optional). Use `.passthrough()`.

3. `CopilotMcpFileSchema` — Zod object with:
   - `servers`: `z.record(z.string(), CopilotMcpServerSchema).optional().default({})` — NOTE: `servers` NOT `mcpServers`
   - `inputs`: `z.array(CopilotMcpInputSchema).optional().default([])`
   Use `.passthrough()` on the top-level object.

4. `copilotSchemas: Record<string, z.ZodType>` — the registry map:
   ```typescript
   export const copilotSchemas: Record<string, z.ZodType> = {
     'copilot-mcp': CopilotMcpFileSchema,
     'copilot-mcp-server': CopilotMcpServerSchema,
   };
   ```

Use `import { z } from 'zod'`. No other imports needed. Add JSDoc comments explaining why `inputs` must be explicitly modeled (to survive read-mutate-validate-write cycles) and why there is no `disabled` field (Copilot has no server-level disable mechanism).
  </action>
  <verify>
Run: `cd /Users/koenrohrer/Agent-Config-Keeper && npx tsc --noEmit 2>&1 | grep "copilot/schemas"` — should produce no errors.

Also check: `grep -n "servers" src/adapters/copilot/schemas.ts` confirms `servers` (not `mcpServers`) as the key name.
  </verify>
  <done>
`src/adapters/copilot/schemas.ts` exists, exports `CopilotMcpFileSchema` and `copilotSchemas`, uses `servers` key, includes `inputs` array, zero TypeScript compile errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Copilot MCP parser</name>
  <files>src/adapters/copilot/parsers/mcp.parser.ts</files>
  <action>
Create `src/adapters/copilot/parsers/mcp.parser.ts`. Mirror the structure of `src/adapters/claude-code/parsers/mcp.parser.ts` exactly, with these differences:

1. Function name: `parseCopilotMcpFile` (not `parseMcpFile`)
2. Schema key: `'copilot-mcp'` (not `'mcp-file'`)
3. Data key: `servers` (not `mcpServers`)
4. No `disabledServers` parameter — Copilot has no disable mechanism
5. All entries always use `ToolStatus.Enabled` (never Disabled)
6. Metadata includes `transport: config.type` (Copilot uses `type` field, not a separate `transport` field), `url`, `headers: config.headers ?? {}`

Implement:
```typescript
export async function parseCopilotMcpFile(
  fileIO: FileIOService,
  schemaService: SchemaService,
  filePath: string,
  scope: ConfigScope,
): Promise<NormalizedTool[]>
```

The read/validate/extract pattern must match Claude Code exactly:
- `fileIO.readJsonFile(filePath)` → if `!success` return `[makeErrorTool(...)]`
- If `data === null` return `[]` (file absent — not an error)
- `schemaService.validate('copilot-mcp', readResult.data)` → if `!success` return `[makeErrorTool(..., message)]`
- Cast `validation.data` to `{ servers?: Record<string, CopilotMcpServerData> }`
- Call `extractServers(data.servers ?? {}, scope, filePath)` — no `disabledServers`

The `extractServers` function maps entries to NormalizedTool with:
```typescript
{
  id: `mcp:${scope}:${serverName}`,
  type: ToolType.McpServer,
  name: serverName,
  scope,
  status: ToolStatus.Enabled,  // Always — Copilot has no disabled state
  source: { filePath },
  metadata: {
    command: config.command,
    args: config.args ?? [],
    env: config.env ?? {},
    transport: config.type,   // Copilot uses `type` for transport
    url: config.url,
    headers: config.headers ?? {},
  },
}
```

The `makeErrorTool` function is identical to the Claude Code version but uses `'copilot-mcp-error'` prefix is fine to keep as `'mcp-error'` for consistency — check the claude-code implementation for the exact id pattern and replicate it.

Imports needed: `FileIOService`, `SchemaService` (type imports), `ToolType`, `ConfigScope`, `ToolStatus` from enums, `NormalizedTool` from config.
  </action>
  <verify>
Run: `cd /Users/koenrohrer/Agent-Config-Keeper && npx tsc --noEmit 2>&1 | grep "copilot/parsers"` — no errors.

Check: `grep -n "servers" src/adapters/copilot/parsers/mcp.parser.ts` shows `servers` not `mcpServers`.
Check: `grep -n "ToolStatus.Enabled" src/adapters/copilot/parsers/mcp.parser.ts` shows always-Enabled assignment.
  </verify>
  <done>
`src/adapters/copilot/parsers/mcp.parser.ts` exists, exports `parseCopilotMcpFile`, reads `servers` key, always assigns `ToolStatus.Enabled`, zero TypeScript compile errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Copilot MCP writer</name>
  <files>src/adapters/copilot/writers/mcp.writer.ts</files>
  <action>
Create `src/adapters/copilot/writers/mcp.writer.ts`. Mirror the structure of `src/adapters/claude-code/writers/mcp.writer.ts`, with these differences:

1. Uses `servers` key (not `mcpServers`)
2. Schema key is always `'copilot-mcp'` (not a parameter — Copilot always uses the same schema)
3. No `toggleCopilotMcpServer` — Copilot has no disabled field (out of scope per REQUIREMENTS.md)

Implement two functions:

```typescript
/**
 * Remove a Copilot MCP server entry from mcp.json.
 *
 * The mutator spreads `current` first so the `inputs` array and any other
 * top-level fields are preserved. Only the named entry in `servers` is deleted.
 */
export async function removeCopilotMcpServer(
  configService: ConfigService,
  filePath: string,
  serverName: string,
): Promise<void> {
  await configService.writeConfigFile(filePath, 'copilot-mcp', (current: Record<string, unknown>) => {
    const servers = { ...((current.servers as Record<string, unknown>) ?? {}) };
    delete servers[serverName];
    return { ...current, servers };  // spread current first — preserves `inputs`
  });
}

/**
 * Add or replace a Copilot MCP server entry in mcp.json.
 *
 * Creates the file (and .vscode/ directory) if they do not exist —
 * FileIOService.writeJsonFile() calls mkdir({ recursive: true }) automatically.
 * The mutator spreads `current` so `inputs` is preserved on write-back.
 */
export async function addCopilotMcpServer(
  configService: ConfigService,
  filePath: string,
  serverName: string,
  serverConfig: Record<string, unknown>,
): Promise<void> {
  await configService.writeConfigFile(filePath, 'copilot-mcp', (current: Record<string, unknown>) => {
    const servers = { ...((current.servers as Record<string, unknown>) ?? {}) };
    servers[serverName] = serverConfig;
    return { ...current, servers };  // spread current first — preserves `inputs`
  });
}
```

CRITICAL: The mutator must always return `{ ...current, servers }` — never just `{ servers }`. Spreading `current` first ensures `inputs` and any other top-level fields from the original mcp.json are preserved. This is the Pitfall 2 guard from RESEARCH.md.

Import: `ConfigService` as type import only.
  </action>
  <verify>
Run: `cd /Users/koenrohrer/Agent-Config-Keeper && npx tsc --noEmit 2>&1 | grep "copilot/writers"` — no errors.

Check: `grep -n "current, servers" src/adapters/copilot/writers/mcp.writer.ts` — both mutators spread `current`.
Check: `grep -n "mcpServers" src/adapters/copilot/writers/mcp.writer.ts` — zero matches (confirm no wrong key slipped in).
  </verify>
  <done>
`src/adapters/copilot/writers/mcp.writer.ts` exists, exports `addCopilotMcpServer` and `removeCopilotMcpServer`, both mutators spread `current`, uses `servers` key, zero TypeScript compile errors.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/koenrohrer/Agent-Config-Keeper && npx tsc --noEmit` — zero errors
2. All three files exist: `src/adapters/copilot/schemas.ts`, `src/adapters/copilot/parsers/mcp.parser.ts`, `src/adapters/copilot/writers/mcp.writer.ts`
3. `grep -rn "mcpServers" src/adapters/copilot/` — zero matches (confirms no cross-contamination from Claude Code pattern)
4. `grep -rn "servers" src/adapters/copilot/schemas.ts` — confirms the `servers` key is defined
5. `grep -rn "ToolStatus.Disabled" src/adapters/copilot/parsers/` — zero matches (Copilot has no disabled state)
</verification>

<success_criteria>
- Three new files exist and compile cleanly with zero TypeScript errors
- No reference to `mcpServers` anywhere in `src/adapters/copilot/`
- Parser always assigns `ToolStatus.Enabled` (no disabled state for Copilot)
- Writer mutators spread `current` to preserve `inputs` array on write-back
- `copilotSchemas` map exports `'copilot-mcp'` and `'copilot-mcp-server'` keys
</success_criteria>

<output>
After completion, create `.planning/phases/21-mcp-server-support/21-01-SUMMARY.md`
</output>
