---
phase: 21-mcp-server-support
plan: "02"
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/adapters/copilot/copilot.adapter.ts
  - src/extension.ts
  - src/views/tool-tree/tool-tree.command-utils.ts
autonomous: true
requirements: [MCP-01, MCP-02, MCP-03, MCP-04, MCP-05]

must_haves:
  truths:
    - "CopilotAdapter.readTools(McpServer, Project) calls parseCopilotMcpFile on .vscode/mcp.json and returns results"
    - "CopilotAdapter.readTools(McpServer, User) calls parseCopilotMcpFile on {vsCodeUserDir}/mcp.json and returns results"
    - "CopilotAdapter.removeTool() delegates to removeCopilotMcpServer() for McpServer type"
    - "CopilotAdapter.installMcpServer() delegates to addCopilotMcpServer() for both scopes"
    - "CopilotAdapter.getWatchPaths(Project) returns [workspaceMcpJson path] — non-empty triggers FileWatcherManager"
    - "CopilotAdapter.getWatchPaths(User) returns [userMcpJson path]"
    - "copilotSchemas is registered in extension.ts alongside claudeCodeSchemas and codexSchemas"
    - "getJsonPath() returns ['servers', name] for Copilot MCP tools and ['mcpServers', name] for Claude Code tools"
  artifacts:
    - path: "src/adapters/copilot/copilot.adapter.ts"
      provides: "Fully wired CopilotAdapter — readTools, removeTool, installMcpServer, getWatchPaths all real implementations"
      contains: "parseCopilotMcpFile"
    - path: "src/extension.ts"
      provides: "copilotSchemas registered at startup"
      contains: "copilotSchemas"
    - path: "src/views/tool-tree/tool-tree.command-utils.ts"
      provides: "getJsonPath returns correct key for Copilot vs Claude Code MCP servers"
      contains: "servers"
  key_links:
    - from: "src/adapters/copilot/copilot.adapter.ts"
      to: "src/adapters/copilot/parsers/mcp.parser.ts"
      via: "readTools() calling parseCopilotMcpFile()"
      pattern: "parseCopilotMcpFile"
    - from: "src/adapters/copilot/copilot.adapter.ts"
      to: "src/adapters/copilot/writers/mcp.writer.ts"
      via: "removeTool() calling removeCopilotMcpServer(), installMcpServer() calling addCopilotMcpServer()"
      pattern: "addCopilotMcpServer|removeCopilotMcpServer"
    - from: "src/extension.ts"
      to: "src/adapters/copilot/schemas.ts"
      via: "schemas.registerSchemas(copilotSchemas)"
      pattern: "registerSchemas.*copilotSchemas"
---

<objective>
Wire the Phase 21-01 parser/writer/schema files into the live extension by implementing CopilotAdapter's stub methods, registering schemas at startup, and fixing the getJsonPath routing bug for Copilot MCP tools.

Purpose: This plan is what makes MCP-01 through MCP-05 observable to the user — without it, the parser/writer files exist but are never called.

Output: Modified `copilot.adapter.ts` (real implementations replacing Phase 20 stubs), updated `extension.ts` (schema registration), patched `tool-tree.command-utils.ts` (correct JSON path for Copilot).
</objective>

<execution_context>
@/Users/koenrohrer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/koenrohrer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-mcp-server-support/21-RESEARCH.md
@.planning/phases/21-mcp-server-support/21-01-SUMMARY.md
@src/adapters/copilot/copilot.adapter.ts
@src/adapters/copilot/paths.ts
@src/extension.ts
@src/views/tool-tree/tool-tree.command-utils.ts
@src/types/config.ts
@src/types/enums.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CopilotAdapter MCP methods</name>
  <files>src/adapters/copilot/copilot.adapter.ts</files>
  <action>
Replace the Phase 20 stubs in `src/adapters/copilot/copilot.adapter.ts` with full implementations. Read the file first, then make targeted replacements.

**Imports to add** (at the top, with existing imports):
```typescript
import { parseCopilotMcpFile } from './parsers/mcp.parser.js';
import { addCopilotMcpServer, removeCopilotMcpServer } from './writers/mcp.writer.js';
```

**1. Replace `readTools` stub:**
```typescript
async readTools(type: ToolType, scope: ConfigScope): Promise<NormalizedTool[]> {
  if (type !== ToolType.McpServer) {
    return []; // Phase 22+ handles CustomPrompt, Skill
  }
  if (scope === ConfigScope.Project) {
    if (!this.workspaceRoot) return [];
    return parseCopilotMcpFile(
      this.fileIO,
      this.schemaService,
      CopilotPaths.workspaceMcpJson(this.workspaceRoot),
      scope,
    );
  }
  if (scope === ConfigScope.User) {
    return parseCopilotMcpFile(
      this.fileIO,
      this.schemaService,
      CopilotPaths.userMcpJson(this.vsCodeUserDir),
      scope,
    );
  }
  return [];
}
```

**2. Replace `removeTool` stub:**
```typescript
async removeTool(tool: NormalizedTool): Promise<void> {
  this.ensureWriteServices();
  if (tool.type !== ToolType.McpServer) {
    throw new Error(`CopilotAdapter: removeTool not implemented for ${tool.type} (Phase 22+)`);
  }
  const filePath = this.getMcpFilePath(tool.scope);
  await removeCopilotMcpServer(this.configService!, filePath, tool.name);
}
```

**3. Replace `installMcpServer` stub:**
```typescript
async installMcpServer(
  scope: ConfigScope,
  serverName: string,
  serverConfig: Record<string, unknown>,
): Promise<void> {
  this.ensureWriteServices();
  const filePath = this.getMcpFilePath(scope);
  await addCopilotMcpServer(this.configService!, filePath, serverName, serverConfig);
}
```

**4. Replace `getWatchPaths` stub:**
```typescript
getWatchPaths(scope: ConfigScope): string[] {
  switch (scope) {
    case ConfigScope.Project:
      if (!this.workspaceRoot) return [];
      return [CopilotPaths.workspaceMcpJson(this.workspaceRoot)];
    case ConfigScope.User:
      return [CopilotPaths.userMcpJson(this.vsCodeUserDir)];
    default:
      return [];
  }
}
```

**5. Add private helper** `ensureWriteServices()` if not already present (check — it's likely not since Phase 20 threw inline errors):
```typescript
private ensureWriteServices(): void {
  if (!this.configService || !this.backupService) {
    throw new Error('CopilotAdapter: write services not initialized — call setWriteServices() first');
  }
}
```

**6. Replace `toggleTool` stub** with a permanent no-op/throw (Copilot has no disabled state — this is out of scope permanently):
```typescript
async toggleTool(_tool: NormalizedTool): Promise<void> {
  throw new Error('CopilotAdapter: Copilot MCP servers have no enable/disable state — toggle is not supported');
}
```

**7. Update JSDoc** on the class: Change "Phase 20 — Scaffold only: All read methods return empty arrays..." to reflect that Phase 21 implements full MCP read/write/remove/watch. Keep the note about Phase 22+ for CustomPrompt and Skill types.

Remove Phase 20 scaffold comments from the implemented methods. Update method-level JSDoc to describe actual behavior.
  </action>
  <verify>
Run: `cd /Users/koenrohrer/Agent-Config-Keeper && npx tsc --noEmit 2>&1 | grep -E "copilot\.adapter|copilot/parsers|copilot/writers"` — no errors.

Check: `grep -n "parseCopilotMcpFile\|addCopilotMcpServer\|removeCopilotMcpServer" src/adapters/copilot/copilot.adapter.ts` — all three appear.
Check: `grep -n "Phase 21+" src/adapters/copilot/copilot.adapter.ts` — zero matches (stubs replaced).
  </verify>
  <done>
`copilot.adapter.ts` imports and calls parser/writer functions, `readTools` routes by type and scope, `removeTool` and `installMcpServer` use write services, `getWatchPaths` returns non-empty arrays, `ensureWriteServices` private helper exists, zero TypeScript compile errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register copilotSchemas in extension.ts + fix getJsonPath for Copilot MCP</name>
  <files>src/extension.ts, src/views/tool-tree/tool-tree.command-utils.ts</files>
  <action>
Two targeted edits:

**A. extension.ts — register copilotSchemas**

Add `copilotSchemas` import alongside existing schema imports:
```typescript
import { copilotSchemas } from './adapters/copilot/schemas.js';
```

Then add schema registration immediately after the existing `schemas.registerSchemas(codexSchemas)` call:
```typescript
schemas.registerSchemas(copilotSchemas);
```

The registration block should read:
```typescript
schemas.registerSchemas(claudeCodeSchemas);
schemas.registerSchemas(codexSchemas);
schemas.registerSchemas(copilotSchemas);  // ADD THIS LINE
```

**B. tool-tree.command-utils.ts — fix getJsonPath for Copilot**

The current `getJsonPath()` signature is:
```typescript
export function getJsonPath(
  tool: Pick<NormalizedTool, 'type' | 'name' | 'metadata'>,
): (string | number)[]
```

Copilot tools have their file path in `tool.source.filePath`. To detect them, extend the Pick to include `source` (which is already on NormalizedTool as `ToolSource { filePath: string }`):

```typescript
export function getJsonPath(
  tool: Pick<NormalizedTool, 'type' | 'name' | 'metadata' | 'source'>,
): (string | number)[] {
  switch (tool.type) {
    case ToolType.McpServer: {
      // Copilot mcp.json uses "servers" key; Claude Code and Codex use "mcpServers"
      // Copilot paths: .vscode/mcp.json (project) or {Code/User}/mcp.json (user)
      const fp = tool.source?.filePath ?? '';
      const isCopilot = fp.endsWith('mcp.json') &&
        (fp.includes('.vscode') || fp.includes('Code/User') || fp.includes('Code\\User'));
      return [isCopilot ? 'servers' : 'mcpServers', tool.name];
    }
    case ToolType.Hook:
      return ['hooks', tool.metadata.eventName as string];
    case ToolType.Skill:
    case ToolType.Command:
    case ToolType.CustomPrompt:
      return [];
  }
}
```

IMPORTANT: Changing the signature of `getJsonPath` from `Pick<..., 'type' | 'name' | 'metadata'>` to include `'source'` requires that all callers pass `source`. Find all call sites with `grep -rn "getJsonPath" src/` and verify each passes an object that includes `source`. If any caller constructs a partial object without `source`, update it to include `source: tool.source` or `source: { filePath: '' }` as appropriate.

Also update the existing test in `src/test/unit/tool-tree.commands.test.ts`: the `makeTool` helper currently does not include `source`. Add `source: { filePath: '' }` to the helper's return value (or add it explicitly to test cases for Copilot path detection). Add new test cases:
- `getJsonPath` returns `['servers', name]` for a tool with `source.filePath` containing `.vscode`
- `getJsonPath` returns `['mcpServers', name]` for a tool with `source.filePath` containing `.mcp.json`
  </action>
  <verify>
Run: `cd /Users/koenrohrer/Agent-Config-Keeper && npx tsc --noEmit` — zero errors across entire project.

Check: `grep -n "copilotSchemas" src/extension.ts` — appears after `codexSchemas` registration.
Check: `grep -n "'servers'" src/views/tool-tree/tool-tree.command-utils.ts` — exists in McpServer case.
Check: `grep -n "isCopilot" src/views/tool-tree/tool-tree.command-utils.ts` — path-detection logic present.

Run: `cd /Users/koenrohrer/Agent-Config-Keeper && npm test 2>&1 | tail -20` — tests pass (including updated getJsonPath tests).
  </verify>
  <done>
`copilotSchemas` registered in `extension.ts`, `getJsonPath` correctly distinguishes Copilot (`.vscode` or `Code/User` path) from Claude Code (returns `servers` vs `mcpServers`), existing tests updated to pass `source`, new Copilot-path test cases added, zero TypeScript compile errors, test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/koenrohrer/Agent-Config-Keeper && npx tsc --noEmit` — zero errors
2. `cd /Users/koenrohrer/Agent-Config-Keeper && npm test` — all tests pass
3. `grep -n "parseCopilotMcpFile\|addCopilotMcpServer\|removeCopilotMcpServer" src/adapters/copilot/copilot.adapter.ts` — all three present
4. `grep -n "copilotSchemas" src/extension.ts` — appears in import and registerSchemas call
5. `grep -n "servers" src/views/tool-tree/tool-tree.command-utils.ts` — Copilot branch returns `['servers', name]`
6. `grep -rn "Phase 21+" src/adapters/copilot/copilot.adapter.ts` — zero matches (stubs replaced)
</verification>

<success_criteria>
- CopilotAdapter's MCP stub methods are replaced with real implementations routing through parser/writer
- `getWatchPaths()` returns non-empty arrays, enabling FileWatcherManager to watch `.vscode/mcp.json`
- `copilotSchemas` is registered in `extension.ts` so `ConfigService.writeConfigFile()` can validate Copilot MCP files
- `getJsonPath()` returns `['servers', name]` for Copilot MCP servers and `['mcpServers', name]` for Claude Code
- Full project compiles and test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/21-mcp-server-support/21-02-SUMMARY.md`
</output>
