---
phase: 21-mcp-server-support
plan: "03"
type: tdd
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/test/unit/copilot-mcp.test.ts
autonomous: true
requirements: [MCP-01, MCP-02, MCP-03, MCP-04]

must_haves:
  truths:
    - "parseCopilotMcpFile() returns NormalizedTool[] from a valid mcp.json with `servers` key"
    - "parseCopilotMcpFile() returns [] for a missing file (not an error — file absent is valid)"
    - "parseCopilotMcpFile() returns a ToolStatus.Error tool for malformed JSON"
    - "parseCopilotMcpFile() returns zero tools if the file has `mcpServers` key instead of `servers` (wrong key — not an error, just empty)"
    - "addCopilotMcpServer() writes a new server entry under `servers` key and preserves existing `inputs` array"
    - "removeCopilotMcpServer() deletes the named entry from `servers` and preserves remaining entries and `inputs`"
    - "All tests pass with `npm test`"
  artifacts:
    - path: "src/test/unit/copilot-mcp.test.ts"
      provides: "Copilot MCP parser and writer test suite"
      contains: "parseCopilotMcpFile"
  key_links:
    - from: "src/test/unit/copilot-mcp.test.ts"
      to: "src/adapters/copilot/parsers/mcp.parser.ts"
      via: "import { parseCopilotMcpFile }"
      pattern: "parseCopilotMcpFile"
    - from: "src/test/unit/copilot-mcp.test.ts"
      to: "src/adapters/copilot/writers/mcp.writer.ts"
      via: "import { addCopilotMcpServer, removeCopilotMcpServer }"
      pattern: "addCopilotMcpServer|removeCopilotMcpServer"
---

<objective>
TDD cycle for `parseCopilotMcpFile`, `addCopilotMcpServer`, and `removeCopilotMcpServer`. The tests drive verification of the three critical pitfalls identified in RESEARCH.md: (1) wrong key silently returns empty, (2) `inputs` array preserved on write-back, (3) file missing returns empty not error.

Purpose: Executable regression guard. These tests prevent `mcpServers` vs `servers` confusion from ever regressing and confirm the `inputs`-preservation invariant on every run.

Output: `src/test/unit/copilot-mcp.test.ts` — fully passing test suite.
</objective>

<execution_context>
@/Users/koenrohrer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/koenrohrer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-mcp-server-support/21-RESEARCH.md
@.planning/phases/21-mcp-server-support/21-01-SUMMARY.md
@src/test/unit/parsers.test.ts
@src/adapters/copilot/schemas.ts
@src/adapters/copilot/parsers/mcp.parser.ts
@src/adapters/copilot/writers/mcp.writer.ts
@src/services/fileio.service.ts
@src/services/schema.service.ts
@src/services/config.service.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: RED — Write Copilot MCP test suite</name>
  <files>src/test/unit/copilot-mcp.test.ts</files>
  <action>Write all test cases per the feature spec below. Run `npm test` and confirm tests run (may pass immediately since Plan 01 already implemented the functions). Follow RED-GREEN-REFACTOR cycle.</action>
  <verify>
`npm test` passes. `grep -c "it(" src/test/unit/copilot-mcp.test.ts` reports at least 10 test cases. Tests cover: servers key, missing file, malformed JSON, wrong key (mcpServers), inputs preservation, add, remove.
  </verify>
  <done>All test cases pass. Pitfall 1 (wrong key) and Pitfall 2 (inputs preservation) regression tests exist and pass.</done>
</task>
</tasks>

<feature>
  <name>Copilot MCP Parser and Writer</name>
  <files>src/test/unit/copilot-mcp.test.ts, src/adapters/copilot/parsers/mcp.parser.ts, src/adapters/copilot/writers/mcp.writer.ts</files>
  <behavior>
parseCopilotMcpFile():
  - valid mcp.json with `servers` key → NormalizedTool[] with all entries, ToolStatus.Enabled
  - missing file → [] (empty array, no error)
  - malformed JSON → [ToolStatus.Error tool] (single error entry)
  - valid file with `mcpServers` key (wrong key) → [] (Zod passes on unknown key via passthrough; `servers` is absent → empty record → empty array — NOT an error)
  - multiple servers → all returned, all Enabled, all with correct id format `mcp:{scope}:{name}`

addCopilotMcpServer():
  - adds server to empty file → file created with { servers: { name: config } }
  - adds server to file with existing servers → both present in output
  - adds server to file with `inputs` array → `inputs` preserved unchanged in output
  - adds server with same name → overwrites existing entry

removeCopilotMcpServer():
  - removes existing server → remaining servers intact, `inputs` preserved
  - remove non-existent name → file unchanged (no error)

Cases: (all use real FileIOService + SchemaService + ConfigService on tmpdir)
  - `parseCopilotMcpFile('/tmp/mcp.json', User)` where file has `{ servers: { myServer: { type: 'stdio', command: 'node' } } }` → NormalizedTool with name='myServer', status=Enabled
  - `parseCopilotMcpFile('/tmp/nonexistent.json', User)` → []
  - `parseCopilotMcpFile('/tmp/bad.json', User)` where file has `INVALID` → [error tool]
  - `parseCopilotMcpFile('/tmp/mcp.json', User)` where file has `{ mcpServers: { myServer: {...} } }` → [] (wrong key, zero tools, no error)
  - `addCopilotMcpServer(configService, '/tmp/mcp.json', 'myServer', { type:'stdio', command:'node' })` then read → contains myServer
  - `addCopilotMcpServer` on file with `inputs: [{ type: 'promptString', id: 'token' }]` → inputs preserved after write
  - `removeCopilotMcpServer(configService, '/tmp/mcp.json', 'myServer')` → myServer absent, others intact
  </behavior>
  <implementation>
Mirror the test structure from `src/test/unit/parsers.test.ts`:
- Use `vitest` (describe/it/expect/beforeEach/afterEach)
- Use real `FileIOService`, `SchemaService`, `ConfigService` — no mocks
- Register `copilotSchemas` in the test's SchemaService instance (not `claudeCodeSchemas`)
- Use `fs.mkdtemp` for isolated tmpdir per suite, clean up in afterEach
- For writer tests: also need `BackupService` and `AdapterRegistry` to construct `ConfigService`

The RED step produces the test file with expectations that fail because the tested functions don't exist yet (they're created in Plan 01 first — so this plan's RED phase writes the test file AFTER Plan 01 completes, but imports may still fail if Plan 01 had compile errors).

Follow RED → GREEN → REFACTOR:
- RED: Write all test cases, run `npm test` — confirm tests FAIL with expected errors (module exists, implementations may be incorrect)
- GREEN: Tests should pass after Plan 01 creates the correct implementations
- REFACTOR: Minor cleanup only if needed

Commit sequence:
1. `test(21-03): add failing Copilot MCP parser+writer tests`
2. `feat(21-03): (should be no-op — Plan 01 already implemented)` or just confirm GREEN
3. `refactor(21-03): clean up test helpers` (if needed)
  </implementation>
</feature>

<verification>
1. `cd /Users/koenrohrer/Agent-Config-Keeper && npm test 2>&1 | grep -E "copilot-mcp|PASS|FAIL"` — copilot-mcp suite appears and passes
2. `npm test` — zero failing tests across entire suite
3. `grep -c "it(" src/test/unit/copilot-mcp.test.ts` — at least 10 test cases
4. Pitfall 1 regression test exists: `grep "mcpServers" src/test/unit/copilot-mcp.test.ts` — test for wrong-key returning empty
5. Pitfall 2 regression test exists: `grep "inputs" src/test/unit/copilot-mcp.test.ts` — test for inputs preservation
</verification>

<success_criteria>
- `src/test/unit/copilot-mcp.test.ts` exists with at least 10 test cases
- All tests pass (`npm test` exits with code 0)
- Test cases cover: parser empty file, parser missing file, parser malformed JSON, parser wrong key (Pitfall 1), writer inputs preservation (Pitfall 2), writer add, writer remove, writer remove non-existent
- Zero TypeScript compile errors in test file
</success_criteria>

<output>
After completion, create `.planning/phases/21-mcp-server-support/21-03-SUMMARY.md`
</output>
