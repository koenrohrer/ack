---
phase: 20-copilot-adapter-scaffold
plan: "02"
type: execute
wave: 2
depends_on:
  - "20-01"
files_modified:
  - eslint.config.mjs
  - src/views/agent-switcher/agent-switcher.quickpick.ts
  - src/views/marketplace/marketplace.panel.ts
autonomous: true
requirements:
  - UX-01
  - UX-02
  - UX-03

must_haves:
  truths:
    - "ESLint reports an error if any file outside src/adapters/copilot/ imports directly from **/adapters/copilot/**"
    - "copilot.adapter.ts itself can import from paths.ts without triggering the ESLint boundary error"
    - "Copilot does NOT appear in the agent switcher QuickPick when GitHub.copilot extension is not installed"
    - "Copilot DOES appear in the agent switcher QuickPick when GitHub.copilot extension is installed"
    - "Marketplace scope prompt shows '(.vscode)' hint when Copilot is the active agent, not '(.claude)'"
    - "Sidebar, marketplace, and profile panel reflect the active agent when Copilot is selected (UX-03 — existing onDidSwitchAgent fan-out handles this)"
  artifacts:
    - path: "eslint.config.mjs"
      provides: "ESLint boundary guard covering copilot adapter directory"
      contains: "adapters/copilot"
    - path: "src/views/agent-switcher/agent-switcher.quickpick.ts"
      provides: "QuickPick hiding Copilot when not detected"
      contains: "adapter.id === 'copilot'"
    - path: "src/views/marketplace/marketplace.panel.ts"
      provides: "configDir lookup map replacing two-way conditional"
      contains: "CONFIG_DIR_LABELS"
  key_links:
    - from: "src/views/agent-switcher/agent-switcher.quickpick.ts"
      to: "CopilotAdapter.detect()"
      via: "adapter.detect() called inside loop, id check filters Copilot"
      pattern: "adapter\\.id === 'copilot'"
    - from: "src/views/marketplace/marketplace.panel.ts"
      to: "adapter.id"
      via: "CONFIG_DIR_LABELS lookup map"
      pattern: "CONFIG_DIR_LABELS"
---

<objective>
Wire the ESLint boundary guard, QuickPick hide behavior, and marketplace configDir fix for GitHub Copilot — the three platform-wide changes required to complete Phase 20.

Purpose: Plan 01 created the adapter; this plan makes the rest of the codebase behave correctly with it. Without these changes: (1) the ESLint guard would not protect the copilot adapter directory, (2) Copilot would show as "not detected" instead of being hidden when uninstalled, and (3) the marketplace would show "(~/.claude)" when Copilot is active — a known bug documented in STATE.md.

Output: Three modified files, no new files.
</objective>

<execution_context>
@/Users/koenrohrer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/koenrohrer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-copilot-adapter-scaffold/20-CONTEXT.md
@.planning/phases/20-copilot-adapter-scaffold/20-RESEARCH.md
@.planning/phases/20-copilot-adapter-scaffold/20-01-SUMMARY.md

# Key files to modify
@eslint.config.mjs
@src/views/agent-switcher/agent-switcher.quickpick.ts
@src/views/marketplace/marketplace.panel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ESLint boundary guard to cover copilot adapter</name>
  <files>eslint.config.mjs</files>
  <action>
Modify `eslint.config.mjs` to add the copilot adapter to both the ignore list and the no-restricted-imports patterns.

**In the adapter boundary guard block (the config object that has `files: ['src/**/*.ts']` and the `no-restricted-imports` rule):**

1. Add `'src/adapters/copilot/**'` to the `ignores` array alongside `'src/adapters/claude-code/**'` and `'src/adapters/codex/**'`. This allows the copilot adapter itself to import from its own paths.ts.

2. Add a new entry to the `patterns` array:
```javascript
{
  group: ['**/adapters/copilot/*', '**/adapters/copilot/**'],
  message: 'Do not import copilot modules directly. Use IPlatformAdapter methods via AdapterRegistry.',
},
```
Place it directly after the existing codex entry.

The final ignores array for the boundary guard block should contain exactly:
- `'src/adapters/claude-code/**'`
- `'src/adapters/codex/**'`
- `'src/adapters/copilot/**'`
- `'src/extension.ts'`
- `'src/test/**'`
- `'src/views/marketplace/webview/**'`
- `'src/views/config-panel/webview/**'`

The final patterns array should have three entries: claude-code, codex, copilot (in that order).
  </action>
  <verify>
    Run `npm run lint` from /Users/koenrohrer/Agent-Config-Keeper — must pass with no new errors.
    Confirm the guard works: temporarily add `import { CopilotPaths } from '../adapters/copilot/paths.js';` to a non-adapter file (e.g., a test scratch), verify lint reports the boundary violation, then remove the test import.
    Confirm copilot.adapter.ts itself does NOT trigger the boundary error: `npm run lint` must pass cleanly with the copilot adapter importing from paths.ts.
  </verify>
  <done>
    `eslint.config.mjs` contains the copilot boundary guard pattern and the ignore entry. `npm run lint` passes. ESLint prevents any non-adapter file from importing copilot internals directly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Hide Copilot in QuickPick when not installed + fix marketplace configDir</name>
  <files>
    src/views/agent-switcher/agent-switcher.quickpick.ts
    src/views/marketplace/marketplace.panel.ts
  </files>
  <action>
**Part A — QuickPick hide behavior (agent-switcher.quickpick.ts):**

The current loop in `showAgentQuickPick` shows all adapters with a "not detected" label when not installed. Copilot must be **completely hidden** when `GitHub.copilot` extension is not installed (per CONTEXT.md locked decision).

Add a filter inside the loop, immediately after `const detected = await adapter.detect();`:

```typescript
// Copilot is hidden completely when not detected (not shown as "not detected")
// This is per user decision: Copilot must not appear in QuickPick if extension is absent
if (!detected && adapter.id === 'copilot') {
  continue;
}
```

No interface changes needed — this is a convention-based approach using adapter.id directly, as recommended in RESEARCH.md Pattern 3 (Option A).

**Part B — Marketplace configDir fix (marketplace.panel.ts):**

Find line 679 in marketplace.panel.ts (or search for the pattern):
```typescript
const configDir = adapter?.id === 'codex' ? '.codex' : '.claude';
```

Replace with the lookup-map approach:
```typescript
const CONFIG_DIR_LABELS: Record<string, string> = {
  'claude-code': '.claude',
  'codex': '.codex',
  'copilot': '.vscode',
};
const configDir = (adapter?.id && CONFIG_DIR_LABELS[adapter.id]) ?? '.claude';
```

This fix is self-contained and does not require any other changes to marketplace.panel.ts. The `configDir` variable is used immediately after in the scope prompt description strings — verify those lines still compile correctly after the replacement.

After both changes, run compile and full lint.
  </action>
  <verify>
    Run `npm run compile` — must pass with 0 errors.
    Run `npm run lint` — must pass.
    Run `npm run test:unit` — existing test suite must still pass.
    Confirm QuickPick fix: `grep -n "adapter.id === 'copilot'" src/views/agent-switcher/agent-switcher.quickpick.ts` shows the filter line.
    Confirm marketplace fix: `grep -n "CONFIG_DIR_LABELS" src/views/marketplace/marketplace.panel.ts` shows the lookup map.
    Confirm the old pattern is gone: `grep -n "codex.*\.codex.*\.claude\|\.codex.*\.claude" src/views/marketplace/marketplace.panel.ts` should return nothing.
  </verify>
  <done>
    QuickPick skips Copilot adapter when detect() returns false. Marketplace configDir resolves to `.vscode` when Copilot is active adapter. All existing tests pass. Compilation and lint clean.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run compile` passes with 0 errors
2. `npm run lint` passes (no new errors)
3. `npm run test:unit` passes (existing suite)
4. ESLint boundary guard has 3 entries: claude-code, codex, copilot
5. QuickPick contains `adapter.id === 'copilot'` filter for hide-when-not-detected
6. marketplace.panel.ts contains `CONFIG_DIR_LABELS` with entries for claude-code, codex, copilot
7. Old two-way ternary `adapter?.id === 'codex' ? '.codex' : '.claude'` no longer exists in marketplace.panel.ts

Phase 20 is complete when all 5 phase success criteria from ROADMAP are satisfied:
1. User can select "GitHub Copilot" in agent switcher QuickPick (CopilotAdapter registered + QuickPick shows it when detected)
2. Copilot only appears when GitHub Copilot VS Code extension is installed (detect() + QuickPick filter)
3. Switching to Copilot updates sidebar/marketplace/profile panel (existing onDidSwitchAgent fan-out, supportedToolTypes drives tree)
4. ESLint boundary guard covers **/adapters/copilot/* (this plan, Task 1)
5. Marketplace configDir conditional no longer hard-codes .claude as fallback (this plan, Task 2 Part B)
</verification>

<success_criteria>
- ESLint boundary guard protects `src/adapters/copilot/**` from direct imports
- QuickPick completely hides Copilot when `GitHub.copilot` extension is absent
- Marketplace shows `.vscode` config dir hint when Copilot is active (not `.claude`)
- Zero compilation errors, zero new lint errors, all existing tests pass
- All 5 Phase 20 success criteria from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/20-copilot-adapter-scaffold/20-02-SUMMARY.md` following the summary template.
</output>
