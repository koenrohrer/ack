---
phase: 20-copilot-adapter-scaffold
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/adapters/copilot/copilot.adapter.ts
  - src/adapters/copilot/paths.ts
  - src/extension.ts
autonomous: true
requirements:
  - UX-01
  - UX-02

must_haves:
  truths:
    - "GitHub Copilot appears as a selectable option in the agent switcher QuickPick when GitHub.copilot extension is installed"
    - "CopilotAdapter.detect() calls vscode.extensions.getExtension('GitHub.copilot') — no filesystem check"
    - "CopilotAdapter is registered in extension.ts alongside ClaudeCodeAdapter and CodexAdapter"
    - "CopilotPaths module contains all Copilot file path helpers (user MCP, workspace MCP, .github/ dirs)"
    - "VS Code user directory is derived from context.globalStorageUri at construction time and stored as a class field"
    - "All read/write methods on CopilotAdapter throw descriptive errors (scaffold — Phase 21+ implements)"
  artifacts:
    - path: "src/adapters/copilot/copilot.adapter.ts"
      provides: "CopilotAdapter class implementing IPlatformAdapter"
      exports: ["CopilotAdapter"]
      contains: "implements IPlatformAdapter"
      min_lines: 60
    - path: "src/adapters/copilot/paths.ts"
      provides: "CopilotPaths — all Copilot file path helpers"
      exports: ["CopilotPaths"]
      contains: "userMcpJson"
      min_lines: 30
    - path: "src/extension.ts"
      provides: "CopilotAdapter registration and setWriteServices wiring"
      contains: "CopilotAdapter"
  key_links:
    - from: "src/extension.ts"
      to: "src/adapters/copilot/copilot.adapter.ts"
      via: "import and registry.register(copilotAdapter)"
      pattern: "registry\\.register\\(copilotAdapter\\)"
    - from: "src/adapters/copilot/copilot.adapter.ts"
      to: "vscode.extensions.getExtension"
      via: "detect() method"
      pattern: "getExtension\\('GitHub\\.copilot'\\)"
    - from: "src/adapters/copilot/copilot.adapter.ts"
      to: "src/adapters/copilot/paths.ts"
      via: "import CopilotPaths"
      pattern: "CopilotPaths"
---

<objective>
Create the CopilotAdapter scaffold — the foundational adapter class and paths module for GitHub Copilot support, and register it in extension.ts.

Purpose: Phase 20 unlocks all v1.2 Copilot phases (21-25). The adapter must be registered and detectable before any config reading, sidebar display, or marketplace routing can be built. This plan lays the foundation with a correct, typed, scaffold-phase adapter that returns empty arrays from all reads and throws from all writes.

Output: Two new source files (copilot.adapter.ts, paths.ts) and three modified lines in extension.ts — zero net new dependencies.
</objective>

<execution_context>
@/Users/koenrohrer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/koenrohrer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-copilot-adapter-scaffold/20-CONTEXT.md
@.planning/phases/20-copilot-adapter-scaffold/20-RESEARCH.md

# Key prior-phase context needed
@src/adapters/codex/codex.adapter.ts
@src/adapters/codex/paths.ts
@src/adapters/adapter.registry.ts
@src/extension.ts
@src/types/adapter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CopilotPaths module</name>
  <files>src/adapters/copilot/paths.ts</files>
  <action>
Create `src/adapters/copilot/paths.ts`. Mirror the structure of `src/adapters/codex/paths.ts` exactly — export a `CopilotPaths` const object with methods for all Copilot file paths.

Include the following path helpers:

```
CopilotPaths = {
  // User scope — vsCodeUserDir is derived from context.globalStorageUri at adapter construction
  userMcpJson(vsCodeUserDir: string): string
    → path.join(vsCodeUserDir, 'mcp.json')

  // Workspace scope — take workspaceRoot as argument
  workspaceMcpJson(root: string): string
    → path.join(root, '.vscode', 'mcp.json')

  workspaceCopilotInstructionsFile(root: string): string
    → path.join(root, '.github', 'copilot-instructions.md')

  workspaceInstructionsDir(root: string): string
    → path.join(root, '.github', 'instructions')

  workspacePromptsDir(root: string): string
    → path.join(root, '.github', 'prompts')

  workspaceAgentsDir(root: string): string
    → path.join(root, '.github', 'agents')
} as const
```

Import: `import * as path from 'path';` (no other imports needed — no `getHomeDir()` since path derivation uses the VS Code globalStorageUri pattern, not os.homedir()).

Add a JSDoc block at the top of the file explaining:
- ALL Copilot file paths must come from this module
- Copilot uses: user MCP at `{vsCodeUserDir}/mcp.json`, workspace MCP at `.vscode/mcp.json`, instructions at `.github/`, agents at `.github/agents/`
  </action>
  <verify>
    Run `npm run compile` from /Users/koenrohrer/Agent-Config-Keeper — must pass with 0 errors.
    Confirm file exists: `ls src/adapters/copilot/paths.ts`
  </verify>
  <done>
    `src/adapters/copilot/paths.ts` exists, exports `CopilotPaths`, contains all 6 path helpers (userMcpJson, workspaceMcpJson, workspaceCopilotInstructionsFile, workspaceInstructionsDir, workspacePromptsDir, workspaceAgentsDir), and compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CopilotAdapter class</name>
  <files>src/adapters/copilot/copilot.adapter.ts</files>
  <action>
Create `src/adapters/copilot/copilot.adapter.ts`. This is a scaffold-phase adapter — all read methods return empty arrays, all write/remove/toggle/install methods throw descriptive errors.

**Constructor signature (mirror CodexAdapter, add `context` param):**
```typescript
constructor(
  private readonly fileIO: FileIOService,
  private readonly schemaService: SchemaService,
  private readonly workspaceRoot: string | undefined,
  context: vscode.ExtensionContext,
  private configService?: ConfigService,
  private backupService?: BackupService,
)
```

**At construction time, derive the VS Code user directory:**
```typescript
// context.globalStorageUri.fsPath = .../Code/User/globalStorage/publisher.ext/
// One path.dirname = .../Code/User/globalStorage/
// Two path.dirnames = .../Code/User/  (correct — store this)
this.vsCodeUserDir = path.dirname(
  path.dirname(context.globalStorageUri.fsPath)
);
```
Store as `private readonly vsCodeUserDir: string`.

**Required interface fields:**
- `readonly id = 'copilot'`
- `readonly displayName = 'GitHub Copilot'`
- `readonly supportedToolTypes: ReadonlySet<ToolType>` = new Set([ToolType.McpServer, ToolType.CustomPrompt, ToolType.Skill])

**`detect()` — CRITICAL (UX-02):**
```typescript
async detect(): Promise<boolean> {
  return vscode.extensions.getExtension('GitHub.copilot') !== undefined;
}
```
NO filesystem check. NO caching. This is called each time QuickPick opens.

**`setWriteServices(configService, backupService)`** — identical pattern to CodexAdapter.

**Scaffold read/write methods (look at CodexAdapter for correct method signatures from IPlatformAdapter):**
- `readTools(_type, _scope)`: returns `Promise.resolve([])`
- `writeTool(...)`: throws `new Error('CopilotAdapter: write operations not yet implemented (Phase 21+)')`
- `removeTool(...)`: throws same pattern
- `toggleTool(...)`: throws same pattern

**`getWatchPaths(_scope)`**: returns `[]` (Phase 21+ will add watch paths)

**`getMcpFilePath(scope)`**: implement fully using CopilotPaths:
```typescript
case ConfigScope.User: return CopilotPaths.userMcpJson(this.vsCodeUserDir);
case ConfigScope.Project:
  if (!this.workspaceRoot) throw new AdapterScopeError(...);
  return CopilotPaths.workspaceMcpJson(this.workspaceRoot);
default: throw new AdapterScopeError(...);
```

**`getMcpSchemaKey(_scope)`**: return `'copilot-mcp'` (schema registered in Phase 21)

**`getSkillsDir(scope)`**: throw `new AdapterScopeError('GitHub Copilot', scope, 'getSkillsDir (Phase 23+)')`

**`getCommandsDir(scope)`**: throw `new AdapterScopeError('GitHub Copilot', scope, 'getCommandsDir (Copilot has no slash commands)')`

**`getSettingsPath(scope)`**: throw `new AdapterScopeError('GitHub Copilot', scope, 'getSettingsPath (Copilot uses VS Code settings)')`

**Install scaffold methods** (`installSkill`, `installCommand`, `installHook`): throw `AdapterScopeError` with descriptive Phase messages.

Import pattern — mirror codex.adapter.ts imports exactly, substituting Copilot types. Use `AdapterScopeError` if it exists in the codebase (check `src/types/adapter-errors.ts` or equivalent); if not, use `new Error(...)`.

Imports needed:
```typescript
import * as vscode from 'vscode';
import * as path from 'path';
import type { FileIOService } from '../../services/fileio.service.js';
import type { SchemaService } from '../../services/schema.service.js';
import type { ConfigService } from '../../services/config.service.js';
import type { BackupService } from '../../services/backup.service.js';
import type { IPlatformAdapter } from '../../types/adapter.js';
import type { NormalizedTool } from '../../types/config.js';
import { ToolType, ConfigScope } from '../../types/enums.js';
import { CopilotPaths } from './paths.js';
```
(Check that these import paths match the actual codebase structure by looking at codex.adapter.ts imports.)

Do NOT add any imports or functionality beyond what is listed above. Phase 20 is scaffold only.
  </action>
  <verify>
    Run `npm run compile` from /Users/koenrohrer/Agent-Config-Keeper — must pass with 0 errors.
    Run `npm run lint` — must pass (or have same warnings as before, no new errors).
    Confirm: `grep -n "detect\|GitHub.copilot\|vsCodeUserDir" src/adapters/copilot/copilot.adapter.ts` shows the key lines.
  </verify>
  <done>
    `src/adapters/copilot/copilot.adapter.ts` exists, implements `IPlatformAdapter`, has `id = 'copilot'`, `displayName = 'GitHub Copilot'`, `detect()` uses `vscode.extensions.getExtension('GitHub.copilot')`, `vsCodeUserDir` is derived from `context.globalStorageUri`, and compilation passes cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register CopilotAdapter in extension.ts</name>
  <files>src/extension.ts</files>
  <action>
Modify `src/extension.ts` to import and register `CopilotAdapter`. Follow the exact same pattern as `CodexAdapter` registration.

**Import to add** (after the CodexAdapter import line):
```typescript
import { CopilotAdapter } from './adapters/copilot/copilot.adapter.js';
```

**Registration** (after the `codexAdapter` construction and `registry.register(codexAdapter)` call, approximately line 90-91):
```typescript
const copilotAdapter = new CopilotAdapter(fileIO, schemas, workspaceRoot, context);
registry.register(copilotAdapter);
```
Note: `CopilotAdapter` takes `context` as the 4th argument (unlike ClaudeCodeAdapter and CodexAdapter which do not). The `context` variable is already in scope in the `activate()` function.

**setWriteServices wiring** (after the `codexAdapter.setWriteServices(configService, backup)` call, approximately line 97-98):
```typescript
copilotAdapter.setWriteServices(configService, backup);
```

**Startup notification update (discretion item from RESEARCH.md open question #3):** Find the startup message that says "No supported agent platforms detected. Install Claude Code or Codex to get started." and update it to include Copilot: "No supported agent platforms detected. Install Claude Code, Codex, or GitHub Copilot to get started."

After making all changes, run full compile + type-check to verify no regressions.
  </action>
  <verify>
    Run `npm run compile` from /Users/koenrohrer/Agent-Config-Keeper — must pass with 0 errors.
    Run `npm run check-types` if available, or `npm run compile` covers it.
    Confirm: `grep -n "copilotAdapter\|CopilotAdapter" src/extension.ts` shows import, construction, register, and setWriteServices lines.
    Run `npm run test:unit` — must pass (existing 277 tests should still pass; no new test file required for this task).
  </verify>
  <done>
    `extension.ts` imports `CopilotAdapter`, constructs `copilotAdapter` with `(fileIO, schemas, workspaceRoot, context)`, calls `registry.register(copilotAdapter)` and `copilotAdapter.setWriteServices(configService, backup)`. All tests pass. Compilation clean.
  </done>
</task>

</tasks>

<verification>
After all three tasks complete:
1. `npm run compile` passes with 0 errors
2. `npm run lint` has no new errors
3. `npm run test:unit` passes (existing suite)
4. `ls src/adapters/copilot/` shows `copilot.adapter.ts` and `paths.ts`
5. `grep "CopilotAdapter" src/extension.ts` shows 4 lines (import, construct, register, setWriteServices)
6. `grep "getExtension" src/adapters/copilot/copilot.adapter.ts` shows the detect() implementation
</verification>

<success_criteria>
- CopilotAdapter scaffold exists in `src/adapters/copilot/` with correct IPlatformAdapter implementation
- CopilotAdapter.detect() uses VS Code Extension API (UX-02 — no filesystem check)
- CopilotAdapter is registered in extension.ts and appears in the QuickPick as a candidate when Copilot is installed
- CopilotPaths module has all path helpers needed for Phase 21-23 implementation
- Zero compilation errors, zero new lint errors, all existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-copilot-adapter-scaffold/20-01-SUMMARY.md` following the summary template.
</output>
